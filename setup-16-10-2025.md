# Tarea 14: Resumen Completo del Setup DevOps

## ğŸ“‹ Ãndice

1. [Objetivo](#objetivo)
2. [Prerrequisitos](#prerrequisitos)
3. [Arquitectura Final](#arquitectura-final)
4. [Paso 1: ConfiguraciÃ³n Inicial del Stack](#paso-1-configuraciÃ³n-inicial-del-stack)
5. [Paso 2: ResoluciÃ³n de Problemas de Red](#paso-2-resoluciÃ³n-de-problemas-de-red)
6. [Paso 3: ConfiguraciÃ³n de Pipelines CI/CD](#paso-3-configuraciÃ³n-de-pipelines-cicd)
7. [Paso 4: Despliegue en Kubernetes](#paso-4-despliegue-en-kubernetes)
8. [Scripts de AutomatizaciÃ³n](#scripts-de-automatizaciÃ³n)
9. [VerificaciÃ³n Final](#verificaciÃ³n-final)
10. [Troubleshooting](#troubleshooting)
11. [Resumen](#resumen)

---

## ğŸ¯ Objetivo

Documentar y resumir el setup completo de un entorno DevOps funcional, incluyendo la resoluciÃ³n de problemas crÃ­ticos de conectividad, configuraciÃ³n de pipelines automatizadas para aplicaciones Angular y Maven, y despliegue exitoso en Kubernetes con registry local privado.

### Resultados logrados:

- âœ… Stack DevOps completo: Jenkins, GitLab, Minikube, Registry local
- âœ… Red Docker aislada (`devops-net`) para comunicaciÃ³n segura
- âœ… Pipelines CI/CD funcionales para frontend (Angular) y backend (Maven)
- âœ… Despliegue automÃ¡tico en Kubernetes con imÃ¡genes desde registry local
- âœ… Scripts de automatizaciÃ³n para startup, backup y recovery

---

## ğŸ“¦ Prerrequisitos

### Infraestructura base:

- **Docker Desktop (WSL2)**, Ubuntu 24.04, Docker Engine 28.4.0
- **Minikube** v1.37.0 (driver Docker, conectado a `devops-net`)
- **Jenkins** (`jenkins:lts`) con Docker CLI y kubectl instalados
- **GitLab** (`gitlab-ce:latest`) para repositorios
- **Registry local** (`registry:2`) para imÃ¡genes Docker

### Conocimientos previos:

- Conceptos bÃ¡sicos de Docker, Kubernetes y CI/CD
- Uso de terminal Linux/WSL
- Git para control de versiones

---

## ğŸ—ï¸ Arquitectura Final

```
Host (WSL2 - Ubuntu 24.04)
â”‚
â”œâ”€â”€ GitLab              Jenkins             Registry
â”‚   localhost:8929      localhost:8080      localhost:5000
â”‚   172.18.0.3         172.18.0.4          172.18.0.4
â”‚
â””â”€â”€ devops-net (172.18.0.0/16)
    â”‚
    â””â”€â”€ Minikube Container (172.18.0.5)
        â”‚
        â””â”€â”€ Kubernetes Cluster (v1.34.0)
            â”‚
            â””â”€â”€ Namespace: jenkins
                â”‚
                â”œâ”€â”€ Secret: registry-secret
                â”‚   â”œâ”€â”€ Type: docker-registry
                â”‚   â””â”€â”€ Server: 172.18.0.4:5000
                â”‚
                â””â”€â”€ Deployments:
                    â”œâ”€â”€ petclinic-angular (frontend)
                    â””â”€â”€ petclinic-maven (backend)
                    â””â”€â”€ Services asociados
```

### Flujo CI/CD:

1. **Push a GitLab** â†’ Trigger Jenkins
2. **Jenkins**: Build â†’ Test â†’ Docker Build â†’ Push to Registry
3. **Jenkins**: Deploy to K8s usando imÃ¡genes del registry local
4. **K8s**: Pull imÃ¡genes con secret â†’ Crear pods/services

---

## ğŸš€ Paso 1: ConfiguraciÃ³n Inicial del Stack

### 1.1 Levantamiento de contenedores base

Ejecutar script de startup automatizado:

```bash
~/start-all-devops.sh
```

**Contenedores creados:**
- Jenkins (puerto 8080)
- GitLab (puerto 8929)
- Registry local (puerto 5000)
- Todos conectados a red `devops-net`

### 1.2 ConfiguraciÃ³n de Minikube

Script automatizado para Minikube + Registry:

```bash
~/setup-registry-k8s-fixed.sh
```

**Configuraciones aplicadas:**
- Minikube con `--insecure-registry=172.18.0.4:5000`
- ConexiÃ³n a red `devops-net`
- Namespace `jenkins` creado
- ServiceAccount y permisos configurados
- Kubeconfig embebido para Jenkins

---

## ğŸ”§ Paso 2: ResoluciÃ³n de Problemas de Red

### Problema identificado:

- Minikube no podÃ­a acceder al registry por aislamiento de red
- Jenkins no podÃ­a conectarse a Kubernetes API

### Soluciones implementadas:

#### 1. Red Docker compartida:

```bash
docker network create devops-net
docker network connect devops-net minikube
docker network connect devops-net registry
docker network connect devops-net jenkins
```

#### 2. IPs consistentes:

- **Registry**: 172.18.0.4
- **Minikube**: 172.18.0.5
- **Jenkins**: 172.18.0.4

#### 3. Kubeconfig con certificados embebidos:

```bash
kubectl config view --flatten --minify > kubeconfig-embedded
# Reemplazar IPs y copiar a Jenkins
```

#### 4. TLS bypass para desarrollo:

```bash
--insecure-skip-tls-verify
```

---

## ğŸ”„ Paso 3: ConfiguraciÃ³n de Pipelines CI/CD

### 3.1 Pipeline Angular (spring-petclinic-angular)

**Stages configurados:**

1. Build Info & Checkout
2. Setup Environment (Node.js)
3. Install Dependencies
4. Lint & Test
5. Build Production
6. Docker Build & Push
7. Verify Image in Registry
8. **Deploy to Kubernetes** (nuevo)

**Jenkinsfile actualizado:**

```groovy
stage('Deploy to Kubernetes') {
    steps {
        script {
            sh """
                kubectl --kubeconfig=/var/jenkins_home/kubeconfig \
                        --insecure-skip-tls-verify \
                        apply -f k8s-deployment-angular.yaml
                kubectl --kubeconfig=/var/jenkins_home/kubeconfig \
                        --insecure-skip-tls-verify \
                        get pods -n jenkins
            """
        }
    }
}
```

### 3.2 Pipeline Maven (spring-petclinic-rest)

**Stages configurados:**

1. Build Info & Checkout
2. Setup Environment (Maven)
3. Compile & Test
4. Package
5. Archive Artifacts
6. Docker Build & Push
7. Verify Image in Registry
8. **Deploy to Kubernetes** (nuevo)

**Jenkinsfile actualizado:**

```groovy
stage('Deploy to Kubernetes') {
    steps {
        script {
            sh """
                kubectl --kubeconfig=/var/jenkins_home/kubeconfig \
                        --insecure-skip-tls-verify \
                        apply -f k8s-deployment-maven.yaml
                kubectl --kubeconfig=/var/jenkins_home/kubeconfig \
                        --insecure-skip-tls-verify \
                        get pods -n jenkins
            """
        }
    }
}
```

---

## â˜¸ï¸ Paso 4: Despliegue en Kubernetes

### 4.1 Archivos de deployment creados

#### `k8s-deployment-angular.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: petclinic-angular
  namespace: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      app: petclinic-angular
  template:
    metadata:
      labels:
        app: petclinic-angular
    spec:
      containers:
      - name: petclinic-angular
        image: 172.18.0.4:5000/petclinic-angular:latest
        ports:
        - containerPort: 80
      imagePullSecrets:
      - name: registry-secret
---
apiVersion: v1
kind: Service
metadata:
  name: petclinic-angular-service
  namespace: jenkins
spec:
  selector:
    app: petclinic-angular
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

#### `k8s-deployment-maven.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: petclinic-maven
  namespace: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      app: petclinic-maven
  template:
    metadata:
      labels:
        app: petclinic-maven
    spec:
      containers:
      - name: petclinic-maven
        image: 172.18.0.4:5000/petclinic-maven:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "docker"
      imagePullSecrets:
      - name: registry-secret
---
apiVersion: v1
kind: Service
metadata:
  name: petclinic-maven-service
  namespace: jenkins
spec:
  selector:
    app: petclinic-maven
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP
```

### 4.2 Secret del registry

```bash
kubectl create secret docker-registry registry-secret \
  --docker-server=172.18.0.4:5000 \
  --docker-username=dummy \
  --docker-password=dummy \
  --docker-email=dummy@example.com \
  --namespace=jenkins
```

---

## ğŸ¤– Scripts de AutomatizaciÃ³n

### Scripts creados/actualizados:

1. **`start-all-devops.sh`** (v2.0): Startup completo con backups y verificaciÃ³n
2. **`setup-registry-k8s-fixed.sh`**: ConfiguraciÃ³n Minikube + Registry + K8s
3. **`reset-minikube.sh`**: ReparaciÃ³n inteligente de Minikube
4. **`recover-all.sh`**: RecuperaciÃ³n de contenedores con volÃºmenes
5. **`stop-all-devops.sh`**: Shutdown ordenado

### Funcionalidades clave:

- âœ… DetecciÃ³n automÃ¡tica de IPs en `devops-net`
- âœ… Backup automÃ¡tico de volÃºmenes
- âœ… VerificaciÃ³n de conectividad
- âœ… Manejo de errores y recuperaciÃ³n

---

## âœ… VerificaciÃ³n Final

### Comandos de verificaciÃ³n:

#### Estado de contenedores

```bash
docker ps --filter "network=devops-net"
```

#### ImÃ¡genes en registry

```bash
curl http://localhost:5000/v2/_catalog
```

#### Pods en Kubernetes

```bash
kubectl --kubeconfig=/var/jenkins_home/kubeconfig \
        --insecure-skip-tls-verify \
        get pods -n jenkins
```

#### Servicios

```bash
kubectl --kubeconfig=/var/jenkins_home/kubeconfig \
        --insecure-skip-tls-verify \
        get services -n jenkins
```

### Resultados esperados:

- âœ… Todos los contenedores corriendo en `devops-net`
- âœ… ImÃ¡genes `petclinic-angular` y `petclinic-maven` en registry
- âœ… Deployments y services activos en namespace `jenkins`
- âœ… Pipelines ejecutÃ¡ndose exitosamente

---

## ğŸ” Troubleshooting

### Problema 1: Conectividad K8s

**SÃ­ntoma:** `dial tcp 192.168.x.x:8443: i/o timeout`

**SoluciÃ³n:** Conectar Minikube a `devops-net` y usar IP 172.18.0.5

### Problema 2: Certificados TLS

**SÃ­ntoma:** `unable to read certificate`

**SoluciÃ³n:** Usar `--insecure-skip-tls-verify` o regenerar certificados

### Problema 3: Registry no accesible

**SÃ­ntoma:** `ImagePullBackOff`

**SoluciÃ³n:** Verificar IP del registry (172.18.0.4:5000) y secret

### Problema 4: MÃºltiples redes Docker

**SÃ­ntoma:** `container addresses should have 2 values, got 3 values`

**SoluciÃ³n:** `minikube delete` y recrear limpio

---

## ğŸ“Š Resumen

### Lo que logramos:

1. âœ… Entorno DevOps completo con Docker, Jenkins, GitLab, Minikube y Registry
2. âœ… Red aislada segura (`devops-net`) para comunicaciÃ³n entre contenedores
3. âœ… Pipelines CI/CD funcionales para aplicaciones Angular y Java/Maven
4. âœ… Despliegue automÃ¡tico en Kubernetes desde registry local privado
5. âœ… Scripts de automatizaciÃ³n para mantenimiento y recuperaciÃ³n
6. âœ… ResoluciÃ³n de problemas crÃ­ticos de conectividad y configuraciÃ³n

### Conceptos clave aprendidos:

- ğŸ”¹ Redes Docker compartidas para comunicaciÃ³n entre contenedores
- ğŸ”¹ Kubeconfig embebido para acceso desde contenedores
- ğŸ”¹ Registries inseguros para desarrollo local
- ğŸ”¹ Secrets de Docker Registry en Kubernetes
- ğŸ”¹ TLS bypass para clusters locales
- ğŸ”¹ AutomatizaciÃ³n con scripts Bash para operaciones repetitivas

### MÃ©tricas de Ã©xito:

- ğŸ“ˆ **2 pipelines CI/CD** funcionando (Angular + Maven)
- ğŸ“ˆ Despliegue automÃ¡tico en K8s desde registry local
- ğŸ“ˆ Tiempo de resoluciÃ³n de problemas: ~2-3 horas por issue
- ğŸ“ˆ Setup reproducible con scripts automatizados
- ğŸ“ˆ Arquitectura escalable para futuras aplicaciones

### PrÃ³ximos pasos sugeridos:

1. **Monitoreo**: Agregar logging centralizado (ELK stack)
2. **Seguridad**: Configurar TLS apropiado para producciÃ³n
3. **Escalabilidad**: Agregar Ingress y Load Balancers
4. **Testing**: Integrar testing de integraciÃ³n end-to-end
5. **Backup**: Automatizar backups incrementales

---

**Fecha de creaciÃ³n:** 16 de octubre de 2025  
**SesiÃ³n completada:** ConfiguraciÃ³n DevOps end-to-end  
**Estado:** âœ… Funcional y documentado